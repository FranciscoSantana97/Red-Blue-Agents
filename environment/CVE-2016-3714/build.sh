#!/bin/bash

#Variables
curpath=$(realpath $(dirname $0))
input=CVE-2016-3714.c
output=CVE-2016-3714

#(1) Prepare magick
if [ ! -d $curpath/ImageMagick ];
then
	git clone https://github.com/ImageMagick/ImageMagick.git $curpath/ImageMagick
	pushd $curpath/ImageMagick && git checkout e46b7d19de7914881986ef939f690facc7a0198d && popd
fi

if [ -z $(which magick) ];
then
	pushd $curpath/ImageMagick && ./configure && make && popd
    if [ -L /usr/bin/magick ];
    then
        sudo unlink /usr/bin/magick
    fi
	sudo ln -s $curpath/ImageMagick/utilities/magick /usr/bin/magick
fi

#(2) Build daemon
gcc -o $curpath/daemon/$output $curpath/daemon/$input
