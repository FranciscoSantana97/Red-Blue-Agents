#!/bin/bash

#Variables
cve=CVE-2015-5958
curpath=$(realpath $(dirname $0))
outname=phpFileManager-0.9.8
zipname=$outname.zip
url="https://sourceforge.net/projects/phpfm/files/phpFileManager/version%200.9.8/$zipname/download"

#input=CVE-2016-3714.c
#output=CVE-2016-3714

#(1) Download php file manager 0.9.8
if [ ! -f $curpath/$zipname ];
then
    wget -O $curpath/$zipname $url
fi

if [ ! -d $curpath/$outname ];
then
    unzip -d $curpath/$outname $curpath/$zipname
fi

if [ -z "$(apt-cache search nginx)" ];
then
    echo "Install nginx"
    exit
fi

if [ -z "$(apt-cache search php-fpm)" ];
then
    echo "Install php-fpm"
    exit
fi

if [ ! -f /etc/nginx/sites-available/$cve.conf ];
then
    sudo cp $curpath/$cve.conf /etc/nginx/sites-available/$cve.conf
fi

if [ ! -d /var/www/$cve ];
then
    sudo mkdir -p /var/www/$cve
fi

if [ ! -f /var/www/$cve/index.php ];
then
    sudo cp $curpath/$outname/index.php /var/www/$cve/
fi

if [ ! -L "/etc/nginx/sites-enabled/$cve.conf" ];
then
    sudo ln -s /etc/nginx/sites-available/$cve.conf /etc/nginx/sites-enabled/
fi

sudo service php7.0-fpm restart
sudo service nginx restart
